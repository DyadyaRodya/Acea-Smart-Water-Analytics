---
title: "analyse_petrigano"
author: "Anastasia Khudoyarova"
date: "09 01 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# ARIMA 
# Aquifer
## Petrignano
### Data preparation
```{r}
df <- as.data.frame(read.table('./acea-water-prediction/Aquifer_Petrignano.csv', header = TRUE, sep=','))
head(df, n=20)
```


Remove NA elements from data 
```{r}
df <- df[complete.cases(df$Rainfall_Bastia_Umbra),]
rownames(df) <- 1:nrow(df)
head(df, n=20)
```
```{r}
df <- subset(df, select = -c(Depth_to_Groundwater_P25, Temperature_Petrignano ))
colnames(df) <- c("Date", "Rainfall", "Depth_to_Groundwater","Temperature", " Volume", " Hydrometry" )
head(df, n=20)
```

Plot data
```{r, message=FALSE}
library('ggplot2')
library('forecast')
library('zoo')
library('dplyr')
library('data.table')
library('imputeTS')
library('xts')
library('tseries')
library('stats')
library('nlme')
library('fpp')
library('lubridate')
library('TSstudio')
```

### Data preparation
```{r}
# sort by date
df$Date <- as.Date(df$Date, format= "%d/%m/%Y")
df <- df[order(df$Date), ]
interval = df$Date - shift(df$Date, n=1, fill=NA, type="lag")
```
```{r}
for(i in interval)
{
  
  if(isTRUE(i > 1) || is.null(i))
  {
    print(i)
  }
    
}
```


```{r}
#depth <- diff(depth)
depth <- na_interpolation(df$Depth_to_Groundwater, option = "linear")

depth_ts <- ts(depth, start = df$Date[1], frequency=365)
# see that it is not statonary
adf.test(depth,alternative="stationary")
```
```{r}
# box cox func
lambda <- BoxCox.lambda(depth_ts)
lambda
tmp <- BoxCox(depth_ts, lambda = lambda)
plot.ts(BoxCox(depth_ts, lambda = lambda))
# diff to get stationary
depth_ts <- diff(tmp)
# it is really stationary
adf.test(depth_ts,alternative="stationary")
```


lambda=1.999959
plot decomposed data
```{r}
ts_decompose(depth_ts)
```

look at seasonal 
```{r}
ts_seasonal(depth_ts, type = "all")
ts_plot(depth_ts)
```

we can make some decisions from the seasonalty.

As we can see the minimum value of the depth is in November,December.

```{r}
rainfall <- na_interpolation(df$Rainfall, option = "linear")
rainfall_ts <- ts(rainfall, start = df$Date[1], frequency=12)
rainfall_ts <- diff(rainfall_ts)
ts_seasonal(rainfall_ts, type = "all")
```

```{r}
temperature <- na_interpolation(df$Temperature, option = "linear")
temperature_ts <- ts(temperature, start = df$Date[1], frequency=12)
temperature_ts <- diff(temperature_ts)
ts_seasonal(temperature_ts, type = "all")
```

From the plot we can see that the maximum temperature was in August, minimum in December

```{r}
volume <- na_interpolation(df$` Volume`, option = "linear")
volume_ts <- ts(volume, start = df$Date[1], frequency=12)
volume_ts <- diff(volume_ts)
ts_seasonal(volume_ts, type = "all")
```

Maximum volume was in March, minimum in December

```{r}
hydrometry <- na_interpolation(df$` Hydrometry`, option = "linear")
hydrometry_ts <- ts(hydrometry, start = df$Date[1], frequency=12)
hydrometry_ts <- diff(hydrometry_ts)
ts_seasonal(hydrometry_ts, type = "all")
```

Maximum in August, minimum in January.

The volume and hydrometry reached their minimum around the same time

# FOR PREDICT NEEDS:
1. прогнозиорвать полследнее щначение тренда
2. сезонность прогноз
3. остатки - арима
4. все складываем и предсказываем 

MAKE ARIMA FOR RESIDUALS
```{r}
# for resisuals(noise) 
h1 <- 1500 # the length of the testing partition
h2 <- 770
decomposed_ts <- decompose(depth_ts, type=c("additive"))
USgas_split <- ts_split(decomposed_ts$random, sample.out = h1)
train <- na_interpolation(USgas_split$train, option = "linear")
test <- na_interpolation(USgas_split$test, option = "linear")

ts_info(train)
ts_info(test)
```

```{r}
acf(train)
pacf(train)
```

```{r}
arima_1 <- Arima(train, order=c(3,1,1))
arima_1
tsdisplay(residuals(arima_1), lag.max = 20)
fc1 <- forecast(arima_1,h=h1)
accuracy(fc1, test)
test_forecast(forecast.obj = fc1, actual = depth_ts, test = test)
```

